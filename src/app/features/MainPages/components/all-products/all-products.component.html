<section class="bg-white">
    <div class="container mx-auto px-4 py-8">
        <form class="flex flex-col md:flex-row md:items-center gap-3 mb-6" [formGroup]="filters" (ngSubmit)="onSearchNow()">
            <div class="flex-1 relative">
                <input type="text" formControlName="q" placeholder="Search products..."
                    class="w-full rounded-md border px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-600 focus:border-emerald-600" />
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                    <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                </div>
            </div>
            <div>
                <select formControlName="sort"
                    class="rounded-md border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-600">
                    <option value="-sold">Best selling</option>
                    <option value="-ratingsAverage">Top rated</option>
                    <option value="price">Price: Low to High</option>
                    <option value="-price">Price: High to Low</option>
                </select>
            </div>
            <button type="submit" class="rounded-md border px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700">Search</button>
        </form>

        @if ((products$ | async); as prods) {
        @if (prods.data.length > 0) {
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            @for (p of prods.data; track p?._id) {
            <div class="border rounded-xl overflow-hidden hover:shadow-sm transition-shadow">
                <a [routerLink]="['/product', p._id]"><img [src]="p.imageCover || '/images/img3.avif'" [alt]="p.title"
                        class="w-full h-40 object-cover" /></a>
                <div class="p-3">
                    <a [routerLink]="['/product', p._id]" class="text-sm font-medium text-gray-900 line-clamp-2">{{
                        p.title }}</a>
                    <div class="mt-1 flex items-center justify-between">
                        <span class="text-emerald-700 font-semibold">{{ (p.priceAfterDiscount || p.price) | currency
                            }}</span>
                        <span class="text-xs text-gray-500"><i class="fa-solid fa-star text-amber-400"></i> {{
                            p.ratingsAverage || 0 }}</span>
                    </div>
                    <div class="mt-3 flex items-center justify-between gap-2">
                        <button type="button" (click)="addToCart(p._id)"
                            class="inline-flex items-center gap-2 px-3 py-2 rounded-md border hover:bg-gray-50 transition-colors">
                            <i class="fa-solid fa-cart-plus"></i>
                            <span class="hidden sm:inline">Add</span>
                        </button>
                        <button type="button" (click)="toggleWishlist(p._id)"
                            class="inline-flex items-center justify-center h-9 w-9 rounded-md border transition-all duration-200 hover:scale-110"
                            [class.bg-emerald-100]="(wishlist.ids$ | async)?.has(p._id)"
                            [class.border-emerald-600]="(wishlist.ids$ | async)?.has(p._id)"
                            [class.text-emerald-700]="(wishlist.ids$ | async)?.has(p._id)"
                            [class.hover:bg-gray-50]="!(wishlist.ids$ | async)?.has(p._id)"
                            [class.hover:bg-emerald-100]="(wishlist.ids$ | async)?.has(p._id)">
                            <i class="fa-heart" [class.fa-solid]="(wishlist.ids$ | async)?.has(p._id)"
                                [class.fa-regular]="!(wishlist.ids$ | async)?.has(p._id)"></i>
                        </button>
                    </div>
                </div>
            </div>
            }
        </div>
        } @else {
        <div class="text-center py-12">
            <i class="fa-solid fa-search text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">No products found</h3>
            <p class="text-gray-500">Try adjusting your search terms or filters</p>
        </div>
        }
        } @else {
        <div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div>
            <p class="mt-2 text-gray-600">Loading products...</p>
        </div>
        }
    </div>
</section>
